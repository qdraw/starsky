@using System.Globalization
@using System.Linq
@using System.Web
@using Microsoft.AspNetCore.Mvc
@using starsky.Helpers
@using starsky.Services
@using starsky.ViewModels
@model DetailView

@{
    ViewData["Title"] = @Model.FileIndexItem.FileName;
}


<div class="sidebar">
	<div class="close"></div> @*onclick="toggleSideMenu()"*@
	<div class="content">

		<h4 class="nextprev">
			&nbsp;
			@if (@Model.RelativeObjects.PrevFilePath != null)
			{
				var urlPath = @Url.Action("Index", "Home", new { f = @Model.RelativeObjects.PrevFilePath });
				urlPath = urlPath.Replace("%2F", "/");
				<a class="prev" href="@urlPath">Vorige</a>
			}
			@if (@Model.RelativeObjects.NextFilePath != null)
			{
				var urlPath = @Url.Action("Index", "Home", new { f = @Model.RelativeObjects.NextFilePath });
				urlPath = urlPath.Replace("%2F", "/");
				<a class="next" href="@urlPath">Volgende</a>
			}
		</h4>

		<div class="thumbnail">
			<img src="@Url.Action("Thumbnail", "Api", new {f = @Model.FileIndexItem.FileHash + ".jpg", issingleitem = true})" />
		</div>

		<div class="form-inline form-wrapper" id="js-keywords-update">
			<p>Tags: <em>(komma gescheiden)</em></p>
			<div class="form-control js-keywords contenteditable disabled" contenteditable="false"
				 name="keywords" data-previouscontent="@Model.FileIndexItem.Tags">@Model.FileIndexItem.Tags</div> @*onfocusout="updateKeywords()"*@
				<a class="btn btn-default" type="submit">Update</a>
			</div>

			<div class="form-inline form-wrapper" id="js-captionabstract-update">
				<p>Info:</p>
				@*onfocusout="updateCaptionAbstract()"*@
				<div class="form-control js-captionabstract contenteditable disabled" contenteditable="false"
					 name="keywords" data-previouscontent="@Model.FileIndexItem.Description">@Model.FileIndexItem.Description</div>
					<a class="btn btn-default disabled" type="submit">Update</a> @*onClick="updateCaptionAbstract()"*@
				</div>

				<div>
					@{
						if (Model.FileIndexItem.DateTime.Year >= 2)
						{
							var cultureInfo = new CultureInfo("nl-NL");
							<p>Datum: <em>@Model.FileIndexItem.DateTime.ToString(cultureInfo)</em></p>
						}
					}
				</div>
				<div class="add-colorclass">
					@{
						foreach (var item in @FileIndexItem.GetAllColorUserInterface())
						{
							var enumValue = (int)item;
							if ((int)@Model.FileIndexItem.ColorClass == enumValue)
							{
								<a class="colorclass-@enumValue on" data-colorclass="@enumValue">
									@*onclick="updateColorClass(this)"*@
									<span class='checkbox'></span>@item.ToString()
								</a>
							}
							else
							{
								<a class="colorclass-@enumValue" data-colorclass="@enumValue">
									@*onclick="updateColorClass(this)"*@
									<span class='checkbox'></span>@item.ToString()
								</a>
							}
						}
					}
				</div>
				<div class="form-inline form-wrapper" id="js-objectname-update">
					<p>Titel:</p>
					<div class="form-control js-objectname contenteditable disabled" contenteditable="false"
						 name="keywords" data-previouscontent="@Model.FileIndexItem.Title">@Model.FileIndexItem.Title</div>
						@*onfocusout="updateObjectName()"*@
						<a class="btn btn-default disabled" type="submit">Update</a>
						@*onClick="updateObjectName()"*@
					</div>

					<div class="addDeleteTag disabled">
						<h4>Danger zone:</h4>
						<a class="btn-sm btn btn-danger delete">Verwijderen niet beschikbaar</a>  @*onClick="addDeleteTag()"*@
						<a asp-controller="Search" asp-action="Trash" asp-fragment="sidebar=" class="btn-sm btn btn-info">Bekijk prullenmand</a>
						<a class="btn-sm btn btn-danger status204button hide">Reset Thumbnail</a> @*onclick="retry204()"*@
					</div>

					<div class="download-sidebar">
						<h4>Downloads:</h4>

						@if (@Files.IsExtensionThumbnailSupported(@Model.FileIndexItem.FileName))
						{
							<a class="btn-sm btn btn-secondary"
							   href="@Url.Action("DownloadPhoto", "Api", new {f = @Model.FileIndexItem.FilePath, isThumbnail = true})"
							   download="@Model.FileIndexItem.FileName.Replace(".jpg", "")-th.jpg">
								Klein
							</a>
						}

						<a class="btn-sm btn btn-secondary"
						   href="@Url.Action("DownloadPhoto", "Api", new {f = @Model.FileIndexItem.FilePath, isThumbnail = false})"
						   download="@Model.FileIndexItem.FileName">
							Orgineel
						</a>
					</div>
					<div class="location-sidebar">
						<h4>Locatie:</h4>
						@if (Math.Abs(@Model.FileIndexItem.Latitude) > 0.001
							 && Math.Abs(@Model.FileIndexItem.Longitude) > 0.001
							 && !string.IsNullOrEmpty(@Model.FileIndexItem.LocationCity)
							 && !string.IsNullOrEmpty(@Model.FileIndexItem.LocationState)
							 && !string.IsNullOrEmpty(@Model.FileIndexItem.LocationState))
						{
							<a target="_blank"
							   href="https://www.openstreetmap.org/?mlat=@Model.FileIndexItem.Latitude&mlon=@Model.FileIndexItem.Longitude#map=15/@Model.FileIndexItem.Latitude/@Model.FileIndexItem.Longitude">
								@Model.FileIndexItem.LocationCity, @Model.FileIndexItem.LocationState (@Model.FileIndexItem.LocationCountry)
							</a><br />
							<em>Opent in nieuw tabblad</em>
						}
						else if (Math.Abs(@Model.FileIndexItem.Latitude) > 0.001
								  && Math.Abs(@Model.FileIndexItem.Longitude) > 0.001)
						{
							<a target="_blank"
							   href="https://www.openstreetmap.org/?mlat=@Model.FileIndexItem.Latitude&mlon=@Model.FileIndexItem.Longitude#map=15/@Model.FileIndexItem.Latitude/@Model.FileIndexItem.Longitude">
								@Math.Round(@Model.FileIndexItem.Latitude, 5),@Math.Round(@Model.FileIndexItem.Longitude, 5)
							</a><br />
							<em>Opent in nieuw tabblad</em>
						}
						else
						{
							<text>Geen locatie bekend</text>
						}
					</div>
					<div>
						<div class="js-collectionsswitch">
							<h4>Collecties:</h4>
							<div><a class="btn btn-default small" href="#">@Model.FileIndexItem.ImageFormat</a></div>
						</div>

					</div>
					<div class="rotation-sidebar">
						<h4>Rotatie:</h4>
						<a class="btn-sm btn btn-secondary">
							@*onClick="queryRotate(-1)"*@
							[
						</a>
						<a class="btn-sm btn btn-secondary">
							@*onClick="queryRotate(1)"*@
							]
						</a>
					</div>

					<div class="form-inline form-wrapper" id="js-filename-update">
						<p>Filename:</p>
						<div class="form-control js-filename contenteditable disabled" contenteditable="false"
							 name="keywords" data-previouscontent="@Model.FileIndexItem.FilePath">@Model.FileIndexItem.FilePath</div>
							@*onfocusout="updateFilename()"*@
							<a class="btn btn-default disabled" type="submit">Update</a>
							@*onClick="updateFilename()"*@
						</div>





					</div>
				</div>

<div class="detailview">
    <h4 class="nextprev">
        &nbsp;
        @if ( @Model.RelativeObjects.PrevFilePath != null )
        {
            var urlPath = @Url.Action("Index", "Home", new {f = @Model.RelativeObjects.PrevFilePath});
            urlPath = urlPath.Replace("%2F", "/");
            <a class="prev" href="@urlPath">Vorige</a>
        }

        <span class="js-filterinfo">
            @if ( @Model.ColorClassFilterList.Any() )
            {
                <text>Filters:</text>
                foreach ( var item in Model.ColorClassFilterList )
                {
                    var enumValue = ( int ) item;
                    <span class="sqbox on colorclass-@enumValue"></span>
                }

            }
        </span>

        @if ( @Model.ColorClassFilterList.Any() && !Model.ColorClassFilterList.Contains(
            @Model.FileIndexItem.ColorClass) )
        {
            <span>&nbsp;&nbsp;Deze file is buiten de ColorClass selectie</span>
        }

        @if ( @Model.FileIndexItem.Tags.Contains("!delete!") )
        {
            <span>Verwijderd bestand!</span>
        }
        @if ( @Model.RelativeObjects.NextFilePath != null )
        {
            var urlPath = @Url.Action("Index", "Home", new {f = @Model.RelativeObjects.NextFilePath});
            urlPath = urlPath.Replace("%2F", "/");
            <a class="next" href="@urlPath">Volgende</a>

        }
    </h4>

    <h1 class="breadcrumb">
        @foreach ( var item in Model.Breadcrumb )
        {
            var name = @item.Split("/")[item.Split("/").Length - 1];
            if ( name == "" )
            {
                name = "Home";
            }

            var urlPath = @Url.Action("Index", "Home", new {f = @item});
            urlPath = urlPath.Replace("%2F", "/");
            <a href="@urlPath">@name</a>

            <span> &raquo;</span>
        }
        <span>
            @Model.FileIndexItem.FileName
        </span>
    </h1>

	<div class="main-image">
		<img class="disabled-@Model.FileIndexItem.Orientation" src="@Url.Action("Thumbnail", "Api", new {f = @Model.FileIndexItem.FileHash + ".jpg", issingleitem = true})"/>
	</div>
	
	<div id="popup">
		<div class="content">
		</div>
	</div>
	
</div>


<div class="preloader">
    <img src="images/preloader.svg" alt="preloader">
</div>

@{
	// Javascript don't accept decoded slashes
	var thumbnailApiBase = Url.Action("Thumbnail", "Api", new {f = @Model.FileIndexItem.FileHash, json = true});
	thumbnailApiBase = HttpUtility.UrlDecode(thumbnailApiBase);
	var updateApiBase = Url.Action("Update", "Api", new { f = @Model.FileIndexItem.FilePath});
	updateApiBase = HttpUtility.UrlDecode(updateApiBase);
	var infoApiBase = @Url.Action("Info", "Api", new {f = @Model.FileIndexItem.FilePath});
	infoApiBase = HttpUtility.UrlDecode(infoApiBase);
}
<div id="js-settings" data-updateApiBase="@updateApiBase" 
     data-infoApiBase="@infoApiBase" data-thumbnailApiBase="@thumbnailApiBase"
     data-subPath="@Model.SubPath"></div>

<script type="text/javascript" src="js/loadjson.js"></script>
<script src="js/sidebar-stringhelper.js" type="text/javascript"></script>
<script src="js/sidebar.js" type="text/javascript"></script>
<script src="js/detailview.js" asp-append-version="true" type="text/javascript"></script>

@*For IE/IE-Edge "object-fit: cover" *@
<script type="text/javascript" src="~/js/vendor/ofi.min.js" defer></script>

@if (@Model.FileIndexItem.ImageFormat == Files.ImageFormat.gpx)
{
     var downloadUrl = @Url.Action("DownloadPhoto", "Api", 
         new {f = @Model.FileIndexItem.FilePath, isThumbnail = false});
     downloadUrl = HttpUtility.UrlDecode(downloadUrl);
    
    <link rel="stylesheet" href="~/css/leaflet.css" />
    <script src="~/js/vendor/leaflet.min.js"></script>
    <script src="~/js/vendor/leaflet-gpx.min.js"></script>

    <script>
        document.querySelector(".main-image").innerHTML = "<div id=\"map\">" +
            "<div class=\"lock-map\">" +
            "<a class=\"btn btn-info\" onclick=\"enableMap()\">" +
            "Zet kaartnavigeer opties aan</a></div><div class=\"info\"></div></div>";
        var map = L.map('map',{ });

        function disableMap() {
            document.querySelector(".main-image #map").classList.add("disabled");
            map._handlers.forEach(function(handler) {
                handler.disable();
            });
            map.removeControl( map.zoomControl ); 
        }
        function enableMap() {
            document.querySelector(".main-image #map").classList.remove("disabled");
            map._handlers.forEach(function(handler) {
                handler.enable();
            });
            map.addControl( map.zoomControl );
        }
        
        disableMap();
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        

        var gpx = '@downloadUrl'; // URL to your GPX file or the GPX itself

        var blueIcon = new L.icon({
            iconUrl: '../images/fa-map-marker-blue.svg',
            shadowUrl: '../images/marker-shadow.png',
            iconSize:     [50, 50], // size of the icon
            shadowSize:   [50, 50], // size of the shadow
            iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
            shadowAnchor: [15, 55],  // the same for the shadow
            popupAnchor:  [0, -50] // point from which the popup should open relative to the iconAnchor
        });
        
        var gpx = gpx.replace("&amp;", "&");
        new L.GPX(gpx,
            {
                async: true,
                marker_options: {
                    startIcon: blueIcon,
                    endIcon: blueIcon
                },
                polyline_options: { // the line
                    color: "#000"
                }
                
            }).on('loaded', function(e) {
            map.fitBounds(e.target.getBounds());

            document.querySelector(".main-image #map .info").innerHTML =
                '<div class="get_distance"></div> <div class="get_total_speed"></div> <div class="get_moving_speed"></div>';

            var distance = (e.target.get_distance() / 1000).toFixed(2);
            document.querySelector(".main-image #map .get_distance").innerHTML = "Afstand " + distance + " km";
            document.querySelector(".main-image #map .get_total_speed").innerHTML = "Gemiddelde snelheid " + e.target.get_total_speed().toFixed(2) + " km/h";

            console.log(e.target.get_distance());
        }).addTo(map);

    </script>
}
